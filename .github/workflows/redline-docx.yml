name: Redline DOCX (LibreOffice headless) - OPTIMIZED

on:
  workflow_dispatch:
    inputs:
      input_docx:
        description: 'Path to input .docx'
        required: true
        default: 'docs/input.docx'
      edits_csv:
        description: 'Path to edits CSV or JSON'
        required: true
        default: 'edits/edits_sample.csv'
      output_docx:
        description: 'Path to output .docx'
        required: true
        default: 'build/output.docx'

jobs:
  redline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # OPTIMIZATION 1: Enhanced LibreOffice caching
      - name: Cache LibreOffice installation
        uses: actions/cache@v4
        with:
          path: |
            /usr/lib/libreoffice
            /usr/lib/python3/dist-packages/*uno*
            /usr/share/libreoffice
            /var/cache/apt/archives/*.deb
          key: libreoffice-${{ runner.os }}-v3
          restore-keys: |
            libreoffice-${{ runner.os }}-v2
            libreoffice-${{ runner.os }}-

      # OPTIMIZATION 2: Ultra-fast installation with minimal packages
      - name: Install LibreOffice and Python UNO (Ultra-fast)
        run: |
          if [ ! -d "/usr/lib/libreoffice" ]; then
            echo "Installing LibreOffice (minimal)..."
            # Parallel operations for speed
            (sudo apt-get update -qq) &
            # Install only essential packages
            sudo apt-get install -y --no-install-recommends \
              libreoffice-core \
              libreoffice-writer \
              python3-uno \
              xvfb
            echo "✅ LibreOffice installed"
          else
            echo "✅ LibreOffice found in cache"
          fi

      # OPTIMIZATION 3: Simplified Python UNO setup
      - name: Setup Python UNO (Fast)
        id: lo_py
        run: |
          export PYTHONPATH="/usr/lib/python3/dist-packages:/usr/lib/libreoffice/program:$PYTHONPATH"
          if python3 -c "import uno; print('UNO OK')" 2>/dev/null; then
            echo "path=python3" >> $GITHUB_OUTPUT
            echo "pythonpath=/usr/lib/python3/dist-packages:/usr/lib/libreoffice/program" >> $GITHUB_OUTPUT
          else
            echo "path=/usr/lib/libreoffice/program/python3" >> $GITHUB_OUTPUT
            echo "pythonpath=" >> $GITHUB_OUTPUT
          fi

      # OPTIMIZATION 4: Pre-validate files quickly
      - name: Verify input files (Fast)
        run: |
          [ -f '${{ github.event.inputs.input_docx }}' ] || (echo "Input DOCX missing" && exit 1)
          [ -f '${{ github.event.inputs.edits_csv }}' ] || (echo "CSV/JSON missing" && exit 1)
          echo "✅ All input files present"

      # OPTIMIZATION 5: Ultra-streamlined execution
      - name: Run redline job (Ultra-fast)
        env:
          LO_PY: ${{ steps.lo_py.outputs.path }}
          PYTHONPATH: ${{ steps.lo_py.outputs.pythonpath }}
          UNO_PATH: /usr/lib/libreoffice/program
          DISPLAY: :99
        run: |
          mkdir -p build

          # Kill any existing processes immediately
          sudo pkill -f soffice || true
          sudo pkill -f Xvfb || true

          # Start virtual display with minimal settings
          Xvfb :99 -screen 0 800x600x16 -nolisten tcp > /dev/null 2>&1 &
          
          # Minimal wait time
          sleep 0.5

          # Set environment once
          export PYTHONPATH="$PYTHONPATH"
          export UNO_PATH="/usr/lib/libreoffice/program"
          export DISPLAY=:99
          export OMP_NUM_THREADS=1

          # Run with all optimizations enabled
          timeout 300 "$LO_PY" scripts/apply_tracked_edits_libre.py \
            --in "${{ github.event.inputs.input_docx }}" \
            --csv "${{ github.event.inputs.edits_csv }}" \
            --out "${{ github.event.inputs.output_docx }}" \
            --launch \
            --fast

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: redlined-docx-${{ github.run_id }}-${{ github.run_number }}
          path: ${{ github.event.inputs.output_docx }}
